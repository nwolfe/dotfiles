#!/usr/bin/env bash

if pgrep -q Emacs; then
    echo "Error: Emacs currently running, please close before updating"
    exit 1
fi

cd "$EMACSDIR" || return

# shellcheck source=/Users/nwolfe/.dotfiles/utils/log.sh
source "$DOTFILES/utils/log.sh"
# shellcheck source=/Users/nwolfe/.dotfiles/utils/line.sh
source "$DOTFILES/utils/line.sh"

msg() {
    line -
    echo â†’ "$@"
}

{
    # Check if we need to run one-time setup first
    if [ ! -d "$EMACSDIR/.local" ]; then
        msg REFRESH
        bin/doom refresh
        # executes:
        # - autoremove
        # - install
        # - autoloads
        # - recompile

        # Recreate known projects for convenience
        msg PROJECT SYNC
        doom-project-sync
    fi

    # Refresh ENV variables written to .local/env
    msg ENV
    bin/doom env

    # Update Doom and elisp packages
    msg UPGRADE
    bin/doom -y upgrade
    # executes:
    # - doom clean
    # - doom refresh
    # - doom update

    # Compile everything for speed
    # <2019-10-31 Thu>: Temporarily compile only core
    # because full compilation has been buggy recently
    msg COMPILE
    bin/doom -y compile core

    # Verify system/environment is okay
    msg DOCTOR
    bin/doom doctor

} 2>&1 | log "$0"
