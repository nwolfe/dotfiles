#!/usr/bin/env bash

if pgrep -q Emacs; then
    echo "Error: Emacs currently running, please close before updating"
    exit 1
fi

cd "$EMACSDIR" || return

# shellcheck source=/Users/nwolfe/.dotfiles/utils/log.sh
source "$DOTFILES/utils/log.sh"
# shellcheck source=/Users/nwolfe/.dotfiles/utils/line.sh
source "$DOTFILES/utils/line.sh"
# shellcheck source=/Users/nwolfe/.dotfiles/utils/git.sh
source "$DOTFILES/utils/git.sh"

msg() {
    line -
    echo â†’ "$@"
}

view_changes() {
    old=$(echo "$out" | grep "^  Old revision: .*$" | cut -d' ' -f5)
    new=$(echo "$out" | grep "^  New revision: .*$" | cut -d' ' -f5)
    if [ -n "$old" ] && [ -n "$new" ]; then
        url=$(git_web_url .)
        [ -n "$url" ] && open "$url/compare/$old...$new"
    fi
}

{
    # Check if we need to run one-time setup first
    if [ ! -d "$EMACSDIR/.local" ]; then
        msg REFRESH
        bin/doom refresh
        # executes:
        # - autoremove
        # - install
        # - autoloads
        # - recompile

        # Recreate known projects for convenience
        msg PROJECT SYNC
        doom-project-sync
    fi

    # Refresh ENV variables written to .local/env
    msg ENV
    bin/doom env

    # Update Doom and elisp packages
    msg UPGRADE
    out="$(bin/doom -y upgrade)"
    # executes:
    # - doom clean
    # - doom refresh
    # - doom update
    echo "$out"
    view_changes "$out"

    # Compile everything for speed
    msg COMPILE
    bin/doom -y compile

    # Verify system/environment is okay
    msg DOCTOR
    bin/doom doctor

} 2>&1 | log "$0"
